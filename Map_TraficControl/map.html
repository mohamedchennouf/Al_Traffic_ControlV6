<!DOCTYPE html>
<html>

<head>
    <style>
        #mon_canvas {
            border: 1px solid;
            background-color: rgb(23, 156, 6);
        }
    </style>

    <script>

        var myData = null;

        function loadJSON(callback) {
            var xobj = new XMLHttpRequest();
            xobj.overrideMimeType("application/json");
            xobj.open('GET', 'map', true); // Replace 'my_data' with the path to your file
            xobj.onreadystatechange = function () {
                if (xobj.readyState == 4 && xobj.status == "200") {
                    // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
                    callback(xobj.responseText);
                }
            };
            xobj.send(null);
        }

        function buildMap(data) {
            myData = JSON.parse(data);
            var rues = myData.features;
            var c = document.getElementById("mon_canvas");
            var ctx = c.getContext("2d");
            //c.style.transformOrigin = "7.2653077 43.71101";
            ctx.scale(10, 10);
            ctx.lineWidth = 2;
            ctx.strokeStyle = "grey";
            rues.forEach(function (rue, rueIndex) {
                ctx.beginPath();
                posX1 = rue.geometry.coordinates[0][0];
                posX2 = rue.geometry.coordinates[0][1];
                ctx.moveTo(posX1, posX2);
                rue.geometry.coordinates.forEach(function (position, positionIndex) {
                    ctx.lineTo(position[0], position[1]);
                });
                ctx.stroke();
            });


            c.addEventListener("click", function (event) {

                var evenement = confirm("Voulez vous ajouter un evenement ?");
                if (evenement == true) {
                    var posX = event.pageX / 10;
                    var posY = event.pageY / 10;
                    var imageEvent = document.getElementById("event");
                    ctx.drawImage(imageEvent, posX, posY, 3, 3);
                }
            });

            generateFeu();

            function generateFeu() {
                ctx.drawImage(imageLight, 10, 10, 5, 5);
                var imageLight = document.getElementById("lightgreen");
                var rues = myData.features;
                var posX_feu = 0;
                var posY_feu = 0;
                rues.forEach(function (rue, rueIndex) {
                    posX_feu = rue.geometry.coordinates[0][0];
                    posY_feu = rue.geometry.coordinates[0][1];
                    ctx.drawImage(imageLight, posX_feu, posY_feu, 5, 5);
                });
            }
        }

        function getRandomInt(max) {
            return Math.floor(Math.random() * Math.floor(max));
        }

        function getRandomIntMinMax(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min)) + min;
        }





        function generatePositionVehicules() {
            var c = document.getElementById("mon_canvas");
            var ctx = c.getContext("2d");
            var rueIndex = getRandomInt(myData.features.length);
            //console.log(rueIndex);
            var rueDirection = myData.features[rueIndex].properties.vertical;
            var posIndex = getRandomInt(myData.features[rueIndex].geometry.coordinates.length);
            var posXVehicule = myData.features[rueIndex].geometry.coordinates[posIndex][0];
            var posYVehicule = myData.features[rueIndex].geometry.coordinates[posIndex][1];
            var image = document.getElementById("source");
            var image2 = document.getElementById("source2");
            var decalage = 1;

            if (rueDirection) {
                console.log(true);
                //ctx.rotate(Math.PI / 2);
                ctx.drawImage(image2, posXVehicule - decalage, posYVehicule - decalage, 2, 3);
                ctx.restore();
            } else {
                console.log(false);
                ctx.drawImage(image, posXVehicule - decalage, posYVehicule - decalage, 3, 2);
            }
        }

        function PopCars() {
            var nbCar = prompt("Combien de véhicule souhaite aller à cette évènement ?");
            for (var i = 0; i < nbCar; i++) {
                generatePositionVehicules();
            }
        }



        // Converts canvas to an image
        function convertCanvasToImage(canvas) {
            var image = new Image();
            image.src = canvas.toDataURL("image/Car1.png");
            return image;
        }

        loadJSON(buildMap);




    </script>
    <title>Traffic Control V2</title>

</head>

<body>

    <canvas id="mon_canvas" width="1000" height="1000">
        <div style="display:none;">
            <img id="source" src="car0" width="100" height="100">
        </div>
        <div style="display:none;">
            <img id="source2" src="car1" width="100" height="100">
        </div>
        <div style="display:none;">
            <img id="event" src="event" width="100" height="100">
        </div>
        <div style="display:none;">
            <img id="lightgreen" src="lightgreen" width="100" height="100">
        </div>
        <div style="display:none;">
            <img id="lightred" src="lightred" width="100" height="100">
        </div>

    </canvas>
    <button onclick="PopCars()">Pop Cars</button>
</body>

</html>