<!DOCTYPE html>
<html>

<head>
    <style>
        #mon_canvas {
            border: 1px solid;
            background-color: rgb(23, 156, 6);
        }
    </style>

    <script>

        var myData = null;

        function loadJSON(callback) {
            var xobj = new XMLHttpRequest();
            xobj.overrideMimeType("application/json");
            xobj.open('GET', 'map', true); // Replace 'my_data' with the path to your file
            xobj.onreadystatechange = function () {
                if (xobj.readyState == 4 && xobj.status == "200") {
                    // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
                    callback(xobj.responseText);
                }
            };
            xobj.send(null);
        }

        function buildMap(data) {
            myData = JSON.parse(data);
            var rues = myData.features;
            var c = document.getElementById("mon_canvas");
            var ctx = c.getContext("2d");
            //c.style.transformOrigin = "7.2653077 43.71101";
            ctx.scale(10, 10);
            ctx.lineWidth = 2;
            ctx.strokeStyle = "grey";
            rues.forEach(function (rue, rueIndex) {
                ctx.beginPath();
                posX1 = rue.geometry.coordinates[0][0];
                posX2 = rue.geometry.coordinates[0][1];
                ctx.moveTo(posX1, posX2);
                rue.geometry.coordinates.forEach(function (position, positionIndex) {
                    ctx.lineTo(position[0], position[1]);
                });
                ctx.stroke();
            });


            c.addEventListener("click", function (event) {
                var posX = event.pageX / 10;
                var posY = event.pageY / 10
                ctx.moveTo(posX, posY);
                ctx.arc(posX, posY, 0.5, 0, 2 * Math.PI);
                ctx.strokeStyle = "red";
                ctx.stroke();
                //alert(event.pageX + " , " + event.pageY);
            });

        }

        function getRandomInt(max) {
            return Math.floor(Math.random() * Math.floor(max));
        }

        function getRandomIntMinMax(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min)) + min;
        }

       function generatePosition(maxNumber){
            return Math.floor(Math.random() * maxNumber)
        }

        function mapToCoordinates(mapJ){
            var coord = [];
            var coordTemp = mapJ.features;
            for(var i = 0; i < coordTemp.length;i++)
            {
                for(var j = 0; j < coordTemp[i].geometry.coordinates.length; j++){
                    coord.push(coordTemp[i].geometry.coordinates[j]);
                }
            }
            return coord;
        }

        function findNumber(tab,elt) {
            var res = false;
            for(var i = 0; i < tab.length; i++){
                if(tab[i] === elt){
                    res = true;
                    //console.log(res);
                }
            }
            //console.log(res);
            return res;
        }
        function generateTabP(num,max){
            var temp = [];
            var val = 0;
            do{
                val = generatePosition(max);
                if(!findNumber(temp,val)){
                    temp.push(val);
                }
            }while(temp.length < num);
            return temp;
        }


        function randomPos(mapJ,numberPos){
            var tabPosT = mapToCoordinates(mapJ);
            var posArray = [];
            var randomPos = [];
            randomPos = generateTabP(numberPos,tabPosT.length);
            for(var i = 0; i < randomPos.length; i++){
                posArray.push(tabPosT[randomPos[i]]);
            }
            //console.log(posArray);
            return posArray;
        }


        function generatePositionVehicules() {
            var c = document.getElementById("mon_canvas");
            var ctx = c.getContext("2d");
            var rueIndex = getRandomInt(myData.features.length);
            var nbCars = 5; // nombre de cars ne peut pas depasser le nombre coordonne de la carte.
            var car = randomPos(myData,nbCars);
           
            //console.log(rueIndex);
            var rueDirection = myData.features[rueIndex].properties.vertical;
            var posIndex = getRandomInt(myData.features[rueIndex].geometry.coordinates.length);
            /*var posXVehicule = myData.features[rueIndex].geometry.coordinates[posIndex][0];
            var posYVehicule = myData.features[rueIndex].geometry.coordinates[posIndex][1];*/

          

            var image = document.getElementById("source");
            var image2 = document.getElementById("source2");
            var decalage = 1;
            
            for(var i = 0 ; i < car.length; i++){
                var posXVehicule = car[i][0];
                var posYVehicule = car[i][1];
                if (rueDirection) {
                    //console.log(true);
                    //ctx.rotate(Math.PI / 2);
                    ctx.drawImage(image2, posXVehicule - decalage, posYVehicule - decalage, 2, 3);
                    ctx.restore();
                } else {
                    //console.log(false);
                    ctx.drawImage(image, posXVehicule - decalage, posYVehicule - decalage, 3, 2);
                }
            }

        }




        // Converts canvas to an image
        function convertCanvasToImage(canvas) {
            var image = new Image();
            image.src = canvas.toDataURL("image/Car1.png");
            return image;
        }

        loadJSON(buildMap);




    </script>
    <title>Traffic Control V2</title>

</head>

<body>

    <canvas id="mon_canvas" width="1100" height="1100">
        <div style="display:none;">
            <img id="source" src="car0" width="50" height="50">
        </div>
        <div style="display:none;">
            <img id="source2" src="car1" width="50" height="50">
        </div>
        
    </canvas>
    <button onclick="generatePositionVehicules()">Pop Cars</button>
</body>

</html>